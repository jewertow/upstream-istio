# TODO: move TLS origination to a dedicated destination rule
# TODO: rename .port to .forwardProxyPort
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: tunnel-outbound-traffic-to-external-svc-via-external-forward-proxy
spec:
  host: external-forward-proxy.{{ .externalNamespace }}.svc.cluster.local
  subsets:
  - name: external-svc-http
    trafficPolicy:
      tunnel:
        protocol: CONNECT
        targetHost: external.{{ .externalNamespace }}.svc.cluster.local
        targetPort: {{ .externalSvcTcpPort }}
    {{ if .tlsEnabled }}
      portLevelSettings:
      - port:
          number: {{ .forwardProxyPort }}
        tls:
          mode: SIMPLE
          sni: external-forward-proxy.{{ .externalNamespace }}.svc.cluster.local
    {{ end }}
  - name: external-svc-https
    trafficPolicy:
      tunnel:
        protocol: CONNECT
        targetHost: external.{{ .externalNamespace }}.svc.cluster.local
        targetPort: {{ .externalSvcTlsPort }}
    {{ if .tlsEnabled }}
      portLevelSettings:
      - port:
          number: {{ .forwardProxyPort }}
        tls:
          mode: SIMPLE
          sni: external-forward-proxy.{{ .externalNamespace }}.svc.cluster.local
    {{ end }}
